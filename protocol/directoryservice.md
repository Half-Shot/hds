Directory Service Protocol Document
-----------------------------------

The Directory Service is used for storing the location of a server and any metadata about services it is running. 

## Overview

Each server wishing to store information about themselves must first generate a public/private key pair. The servers name
will be determined by it's public key (encoded in base56) and every payload it sends must include the signature of the payload
to ensure it always comes from a trusted host.

Topics are UTF8 strings which uniquely define a structured set of data. These SHOULD be in the java package format, e.g.
`uk.half-shot.weather` would define a weather topic owned by half-shot.uk. You will find inside [topics.md](./topics.md)
some common topics defined by the protocol for implementors to use.

Keys:

- `server` - The public key generated by your server. All server names are encoded base58.
- `topic` - A topic that the server supports, an example could be "weather".

All payloads should be signed by the server's private key, and the signature should be stored in the `X-Signature` header.

Payloads should be supplied in CBOR format.

All HTTP endpoints must start with `/_hds/`.

## Signing keys

Problem: Keys are too long.

Solution: Define a hashing algorithm for shortening them to <64 characters, while requiring verified transactions to include the full pub key.


## Confirming a host

When storing the `hds.host` key, the host itself must verify that you are the owner of that host. In order to do this,
the directory will make a request to `POST http://${host}/_hds/verify_host` with a randomly generated secret.

The service should respond with the same payload, but include a signature in `X-Signature` to compare.

```json
{
	"hds.servername": "PUBKEY"
	"hds.signature": "SIGNATURE"
}
```

where PUBKEY is the public key of the hds service defined above, and `SIGNATURE` is the signed contents of this JSON
EXCLUDING the `hds.signature` key and any whitespace.

The directory service will read the file and verify that the `PUBKEY` matches the servername given in the request to the service.
It will also verify that the signature is signed by the `PUBKEY`.

If both of these checks pass, the request to store the key may succeed.
  - If an existing `hds.host` exists, then the existing entry should be removed. 

If the check fails, a HTTP 403 should be returned with an appropriate error object:

- `hds.error.hostvalidation.badpubkey`
- `hds.error.hostvalidation.badhost`
- `hds.error.hostvalidation.hostcontactfailure`
- `hds.error.hostvalidation.signatureinvalid`

## Host Exclusion

Servers are considered excluded if the TTL on `hds.host` expires.

Servers should be excluded from any listings in `/_hds/topics` but NOT exluded
from  `/_hds/servers`, so requests made directly to the host can still be performed.

## Federation

HDS services may fetch state from other HDSes. If a host cannot be found on a given HDS, then
the service should attempt to contact other HDS services it is aware of. HDSes can register with
each other much like other services do, by providing state and registering a topic of `hds.directory`.


## Defaults

The default port for all requests is `20712`

## Errors

Errors should be in the format of:

```json
{
    "hds.error.text": "Your public key does not match the servers",
    "hds.error" "hds.error.hostvalidation.badpubkey",
}
```

Errors *should* use an appropriate HTTP response code.

## Endpoints

### Topic endpoints `/_hds/topics`

#### `GET /_hds/topics` 

Get a list of topics available on the directory.
The list should contain a set of all available topics

```json
{
	"topics": ["hds.news", "hds.wiki", "hds.iot.weather", "hds.directory"]
}
```

#### `GET /_hds/topics/{topic}` 

Get a list of servers that support this topic

```json
{
	"servers": ["PUBKEY", "PUBKEY"]
}
```

#### `GET /_hds/topics/{topic}/{subtopic}/..{subtopic}/..{subtopic}` 

Get a list of servers that support this topic.

```json
{
	"servers": ["PUBKEY", "PUBKEY"]
}
```

### Server endpoints `/_hds/servers/{server}`

#### `GET /_hds/servers/{server}` 

Get all keys about a server from the directory service.

Keys which are "stale", where the TTL has expired, should be stored under
`hds.expired`.

#### `GET /_hds/servers/{server}/topics` 

Get all topics that the server supports.


```json
{
	"topics": ["hds.news", "hds.wiki", "hds.iot.weather"]
}
```

#### `GET /_hds/servers/{server}/topics/{topic}` 

Determine if the server supports a topic, before trying to request information from it.

HTTP 200

```json
{
	"subtopics": [ "politics", "tech", "local/portsmouth", "local/london" ]
}
```

OR 

HTTP 404

```json
{
    "hds.error.text": "This server does not support the topic",
    "hds.error" "hds.error.topic.notfound",
}
```

#### `GET /_hds/servers/{server}/{topic}/{subtopic}/..{subtopic}/..{subtopic}`

Determine if the server supports a topic, and a given subtopic. You may go deeper by adding more subtopics.

HTTP 200

```json
{
	"subtopics": [ "portsmouth", "london" ]
}
```

OR

HTTP 404

```json
{
    "hds.error.text": "This server does not support the subtopic",
    "hds.error" "hds.error.topic.subtopic.notfound",
}
```

OR

HTTP 404

```json
{
    "hds.error.text": "This server does not support the topic",
    "hds.error": "hds.error.topic.notfound",
}
```

#### `PUT /_hds/hosts/{server}/${key}`

Put some state about the server onto the server.


```json
{
  "hds.ttl": "",
  "$key": "",
  "hds.signature": "ABCDEF12345"
}
```

`hds.ttl` is the time for which this information should be considered "live" for, in seconds.
Fields will be considered "expired" if no new information is provided to the service. This
value must be provided for every request.

The payload must contain only one key `hds.host` is defined
before submitting any other types (you may submit these alongside other types).

If the `hds.host` field expires, then you may not change the state of the server until
the value is re-confirmed or changed.

The value of a state must be an integer (int64) or a string (UTF8).

The REQUIRED states for any given host:

- `hds.host` - Hostname of the server. See the confirming host section.

// These are keys, no?

- `hds.ttl` - This defines the TTL of the given keys. Must be set on each transaction.
- `hds.signature` - Result of signing the payload, see Signing Payloads. In base64 format.

There are also a set of states that are useful to provide, but not required:

- `hds.name` - A friendly name for a given host. ex. "Alice's server"
- `hds.contact.name` - A contact name for a host. ex. "Alice"
- `hds.contact.email` - A contact email for a host. ex. "alice@localhost"
- `hds.countrycode` - A country code for the host. ex. "GB"

Some state is set by the directory service:

- `hds.status`* - Will be set to `unavailable` if the ttl on `hds.status` expires.
- `hds.latency` - Average delay in request times (TBD - how to work out the difference?)
- `hds.expired` - This is an array which will contain all keys considered expired.



##### Example

`PUT /_hds/hosts/{server}/state/hds.host`

```json

{
  "hds.ttl": 86400,
  "hds.host": "localhost",
  "hds.signature": ""
}
```

#### `PUT /_hds/hosts/{server}/{topic}`

Register that a server has information on a given topic (and optionally subtopics).

`subtopics` may be empty array if no subtopic applies.

Topics do not expire, although if the server's state is allowed to expire then they will cease to be listed on
topic listings.

```json
{
    "$topic": ["local/portsmouth", "local/london" ],
    "hds.signature": "ABCDEF12345",
}
```
